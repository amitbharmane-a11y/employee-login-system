name: üöÄ Multi-Cloud Deployment

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Choose deployment platform'
        required: true
        default: 'railway-vercel'
        type: choice
        options:
          - railway-vercel
          - render
          - netlify
          - fly-io
          - digitalocean
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'

jobs:
  setup:
    name: 'Setup Deployment'
    runs-on: ubuntu-latest
    outputs:
      platform: ${{ github.event.inputs.platform }}
      environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            */node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  deploy-railway-vercel:
    name: 'Railway + Vercel Deployment'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.platform == 'railway-vercel'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Vercel CLI
        run: npm install -g vercel

      - name: Deploy Backend to Railway
        working-directory: server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway login --token $RAILWAY_TOKEN
          railway init employee-backend --source . --no-confirm
          railway variables set NODE_ENV=production
          railway variables set PORT=5000
          railway variables set MONGO_URI=${{ secrets.MONGODB_URI }}
          railway variables set JWT_SECRET=${{ secrets.JWT_SECRET }}
          railway up --detach

      - name: Get Railway URL
        id: railway-url
        run: |
          sleep 30
          RAILWAY_URL=$(railway domain)
          echo "::set-output name=url::$RAILWAY_URL"

      - name: Deploy Frontend to Vercel
        working-directory: client
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          REACT_APP_API_URL: ${{ steps.railway-url.outputs.url }}/api
        run: |
          npm ci
          npm run build
          npx vercel --prod --yes --token $VERCEL_TOKEN

      - name: Update CORS
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          VERCEL_URL=$(npx vercel --token ${{ secrets.VERCEL_TOKEN }} | grep -o 'https://[^ ]*vercel\.app')
          railway variables set CORS_ORIGIN=$VERCEL_URL

  deploy-render:
    name: 'Render Deployment'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.platform == 'render'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        run: |
          echo "Render deployment would be triggered via webhook"
          echo "Manual deployment required for Render"
          echo "Use: https://render.com ‚Üí New ‚Üí Blueprint"

  deploy-netlify:
    name: 'Netlify Deployment'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.platform == 'netlify'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify
        working-directory: client
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm ci
          npm run build
          netlify deploy --prod --dir=build --auth $NETLIFY_AUTH_TOKEN --site $NETLIFY_SITE_ID

  deploy-fly-io:
    name: 'Fly.io Deployment'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.platform == 'fly-io'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io
        run: curl -L https://fly.io/install.sh | sh

      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          export PATH="$HOME/.fly/bin:$PATH"
          fly deploy --remote-only

  deploy-digitalocean:
    name: 'DigitalOcean Deployment'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.platform == 'digitalocean'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean
        uses: digitalocean/app_action@main
        with:
          app_name: employee-login-system
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          spec_path: .do/app.yaml

  health-check:
    name: 'Health Check'
    runs-on: ubuntu-latest
    needs: [setup, deploy-railway-vercel, deploy-render, deploy-netlify, deploy-fly-io, deploy-digitalocean]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          echo "Deployment platform: ${{ needs.setup.outputs.platform }}"
          echo "Environment: ${{ needs.setup.outputs.environment }}"

          # Add health checks based on platform
          case "${{ needs.setup.outputs.platform }}" in
            "railway-vercel")
              echo "‚úÖ Railway + Vercel deployment completed"
              ;;
            "render")
              echo "‚úÖ Render deployment configured"
              ;;
            "netlify")
              echo "‚úÖ Netlify deployment completed"
              ;;
            "fly-io")
              echo "‚úÖ Fly.io deployment completed"
              ;;
            "digitalocean")
              echo "‚úÖ DigitalOcean deployment completed"
              ;;
          esac

  notify:
    name: 'Deployment Complete'
    runs-on: ubuntu-latest
    needs: [health-check]
    if: success()

    steps:
      - name: Success Notification
        run: |
          echo "üéâ Multi-cloud deployment successful!"
          echo "Platform: ${{ needs.setup.outputs.platform }}"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo ""
          echo "Your Employee Login System is now deployed!"
          echo ""
          echo "Default credentials:"
          echo "- Employee ID: ADMIN001"
          echo "- Password: admin123"
          echo ""
          echo "‚ö†Ô∏è Remember to change the default password!"