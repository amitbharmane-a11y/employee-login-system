name: üöÄ Auto Deploy to Production

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'

jobs:
  setup-infrastructure:
    name: 'Setup Infrastructure'
    runs-on: ubuntu-latest
    outputs:
      mongo-uri: ${{ steps.mongo.outputs.connection-string }}
      backend-url: ${{ steps.backend.outputs.url }}
      frontend-url: ${{ steps.frontend.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Setup MongoDB Atlas
        id: mongo
        run: |
          echo "MongoDB Atlas should be pre-configured"
          echo "Please set MONGODB_URI secret in repository settings"
          echo "::set-output name=connection-string::${{ secrets.MONGODB_URI }}"

  deploy-backend:
    name: 'Deploy Backend to Railway'
    runs-on: ubuntu-latest
    needs: setup-infrastructure
    if: needs.setup-infrastructure.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Railway CLI
        run: |
          npm install -g @railway/cli
          railway login --token ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy to Railway
        working-directory: server
        run: |
          railway init employee-backend --source . --no-confirm
          railway up --detach

      - name: Set Environment Variables
        run: |
          railway variables set NODE_ENV=production
          railway variables set PORT=5000
          railway variables set MONGO_URI=${{ secrets.MONGODB_URI }}
          railway variables set JWT_SECRET=${{ secrets.JWT_SECRET }}
          railway variables set CORS_ORIGIN=${{ secrets.VERCEL_FRONTEND_URL }}

      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(railway domain)
          echo "::set-output name=url::$BACKEND_URL"

  deploy-frontend:
    name: 'Deploy Frontend to Vercel'
    runs-on: ubuntu-latest
    needs: [setup-infrastructure, deploy-backend]
    if: needs.deploy-backend.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: client
        run: npm ci

      - name: Setup Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        working-directory: client
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          REACT_APP_API_URL: ${{ needs.deploy-backend.outputs.backend-url }}/api
        run: |
          vercel --prod --yes --token $VERCEL_TOKEN

      - name: Update CORS
        run: |
          FRONTEND_URL=$(vercel --token $VERCEL_TOKEN | grep -o 'https://[^ ]*')
          echo "Frontend deployed to: $FRONTEND_URL"
          echo "Update Railway CORS_ORIGIN to: $FRONTEND_URL"

  health-check:
    name: 'Health Check'
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Backend Health Check
        run: |
          BACKEND_URL="${{ needs.deploy-backend.outputs.backend-url }}"
          if curl -f -s "$BACKEND_URL/health" > /dev/null; then
            echo "‚úÖ Backend is healthy"
          else
            echo "‚ùå Backend health check failed"
            exit 1
          fi

      - name: Frontend Health Check
        run: |
          FRONTEND_URL="${{ needs.deploy-frontend.outputs.frontend-url }}"
          if curl -f -s "$FRONTEND_URL" > /dev/null; then
            echo "‚úÖ Frontend is healthy"
          else
            echo "‚ùå Frontend health check failed"
            exit 1
          fi

      - name: API Test
        run: |
          BACKEND_URL="${{ needs.deploy-backend.outputs.backend-url }}"
          RESPONSE=$(curl -s -X POST "$BACKEND_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"employeeId":"ADMIN001","password":"admin123"}')

          if echo "$RESPONSE" | grep -q "token"; then
            echo "‚úÖ API login working"
          else
            echo "‚ùå API login failed"
            exit 1
          fi

  notify:
    name: 'Deployment Complete'
    runs-on: ubuntu-latest
    needs: [health-check]
    if: success()

    steps:
      - name: Deployment Success
        run: |
          echo "üéâ Deployment Successful!"
          echo "Frontend: ${{ needs.deploy-frontend.outputs.frontend-url }}"
          echo "Backend: ${{ needs.deploy-backend.outputs.backend-url }}"
          echo "Login: ADMIN001 / admin123"